# トランザクションについて

## ACID 特性

### A

Atomicity (原子性)

トランザクションは、完全に完了する or もとに戻す のどちらかでなくていはいけない

`write A`と`write B`の 2 つの処理が`Transaction X`だとすると`write A`だけもしくは`write B`だけが完了していてはいけない。

残りも完全に完了するか、ロールバックして操作をもとに戻す必要がある。

### C

Consistency (整合性、一貫性)

_コレはいまいちよく分かっていない_

予め与えられた整合性をトランザクションの前後で保たなくてはいけない。

例えば、銀行口座の残高は負になってはいけない、負になる場合は送金できないようにする。などのルールを保証するのが一貫性である。

### I

Isolation (独立性)

トランザクション A で変更しているデータをトランザクション B では処理できない。

トランザクションが直列化されている必要がある。(おそらく直列化して処理すると速度に問題があるので、厳密には直列ではないはず。だがそう見えるようにはなっているはず)

### D

Durability (永続性)

一旦コミットしたら、結果は失われてはいけない

## 排他制御 (同時実行制御)

排他制御には 2 つの制御方法がある。

- ペシミスティック同時制御 (悲観的同時制御)
- オプティミスティック同時制御 (楽観的同時制御)

### ペシミスティック同時制御

これは不整合をあらかじめ防ぐような同時実行制御の方法。

あるトランザクションが特定のデータを更新するためにその値を読むとき、そのデータはロックされ、他のトランザクションでは値の更新が完了してロックが解除されるまで値の読み取りができない。

このように、あるトランザクションでのデータ変更が、他のトランザクションに影響することを**あらかじめ**防ぐ

### オプティミスティック同時制御

不整合が発生したときに不整合を解消すればいいという考えのもと制御する方法。

2 つのトランザクション A,B があったとして、トランザクション A はトランザクション B が更新中でもデータを読み取ることが出来る。
しかし、トランザクション A がデータを更新するとき B がすでにそのデータを書き換えていた場合、処理内容を abort して最初から処理を再開する。

トランザクションの処理中に他のトランザクションによって対象のデータが書き換えられたかどうかは、データベース管理システムが確認している。

もし、すでにデータが更新されていたなら、トランザクションはアボートされ、更新結果を反映した上で、トランザクション処理をやり直す。

### 2 相ロック

リレーション A とリレーション B を更新するトランザクション X があったとする。

トランザクション X はリレーション A を更新する際排他ロックをかける。そして、そのデータの更新を行い、アンロックする。
次にリレーション B での同様の手順で更新を行う。

この場合、複数トランザクションの並列処理が行われた場合、不整合が起こる可能性がある。

そのため、処理対象であるデータに対して、ロック相とアンロック相の 2 つのフェーズに分けることでトランザクションの並列処理を行う。

更新し終わったデータのロックは順次開放するのではなく、アンロック相(アンロックフェーズ)に入ってから開放し始める。

## トランザクションの分離レベル

| 分離レベル       | ダーティーリード | ファジーリード | ファントムリード |
| ---------------- | ---------------- | -------------- | ---------------- |
| READ UNCOMMITTED | o                | x              | x                |
| READ COMMITTED   | o                | x              | x                |
| REPEATABLE READ  | o                | x              | x                |
| SERIALIZABLE     | x                | x              | x                |
